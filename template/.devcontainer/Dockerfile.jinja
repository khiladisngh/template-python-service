FROM python:{{ python_version }}-slim AS dev

# Arguments associated with the non-root user
ARG USERNAME=vscode
ARG USER_UID=1000
ARG USER_GID=${USER_UID}

# Set environment variables for uv
ENV UV_CACHE_DIR=/tmp/uv-cache \
    UV_PYTHON_PREFERENCE=only-system \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install uv
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# Add the non-root user
RUN groupadd --gid "${USER_GID}" "${USERNAME}" \
    && useradd --uid "${USER_UID}" --gid "${USER_GID}" -m "${USERNAME}" \
    && mkdir -p /home/${USERNAME}/.vscode-server /home/${USERNAME}/.vscode-server-insiders \
    && chown ${USER_UID}:${USER_GID} /home/${USERNAME}/.vscode-server*

# Switch to the non-root user
USER ${USERNAME}

# Add uv to PATH for the vscode user
ENV PATH="/root/.cargo/bin:$PATH"

# Set working directory
WORKDIR /home/${USERNAME}/workspace/{{ project_name }}

# Install pre-commit for git hooks
RUN /root/.cargo/bin/uv tool install pre-commit
